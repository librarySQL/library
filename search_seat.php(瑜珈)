<!-- search_seat.php -->

<?php
session_start();

// Add your database connection code here
$conn = new mysqli("localhost", "root", "jenny104408!", "libdb");

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

if (!isset($_SESSION['login']) || $_SESSION['login'] !== true) {
    header("Location: login.php");
    exit;
}

if (isset($_SESSION['account'])) {
    $userId = $_SESSION['account'];
    $accountMessage = isset($_SESSION['account']) ? $_SESSION['account'] . " 您好！" : 'Hello!';
} else {
    header("Location: login.php");
    exit;
}

// Get all seat options
$seatOptions = getSeatOptions($conn);

// Reservation status variable
$reservationStatus = "";

// Handle form submission
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    if (isset($_POST['seatname'])) {
        $selectedSeat = $_POST['seatname'];

        // Check reservation status
        $reservationStatus = checkReservationStatus($conn, $selectedSeat);

        // If the seat is not reserved
       /* if (strpos($reservationStatus, "未被預約") !== false) {
            echo "<p>此座位尚未被預約</p>";

            // Display additional information
            $seatFloor = getSeatFloor($conn, $selectedSeat);
            $socketInfo = getSocketInfo($conn, $selectedSeat);

            echo "<p>樓層：$seatFloor</p>";
            echo "<p>插座資訊：$socketInfo</p>";

            // Display input fields for start and end time
            echo "<form action='../reservation/newreservation.php' method='post'>";
            echo "<input type='hidden' name='seatname' value='$selectedSeat'>";

            // Additional hidden fields to pass seat information
            echo "<input type='hidden' name='seatfloor' value='$seatFloor'>";
            echo "<input type='hidden' name='socket' value='$socketInfo'>";

            echo "開始時間：<input type='datetime-local' name='starttime' required><br>";
            echo "結束時間：<input type='datetime-local' name='endtime' required><br>";
            echo "<button type='submit'>預約座位</button>";
            echo "</form>";
        }*/
    }
}


function checkReservationStatus($conn, $seatName)
{
    // Get current date and time
    $currentDateTime = date('Y-m-d H:i:s');

    // SQL query to check reservation status
    $query = "SELECT * FROM reservation WHERE Seat_Id = (SELECT Seat_Id FROM seat WHERE Seat_Name = '$seatName') AND End_Time > '$currentDateTime' ORDER BY Start_Time";
    $result = $conn->query($query);

    if ($result->num_rows > 0) {
        // Seat is reserved, return reservation information
        $status = "<p>此座位已被預約，預約時間：<br></p>";
        while ($row = $result->fetch_assoc()) {
            $start_time = $row['Start_Time'];
            $end_time = $row['End_Time'];
            $status .= "$start_time 到 $end_time<br>";

            // Include floor and socket information
            $seatFloor = getSeatFloor($conn, $seatName);
            $socketInfo = getSocketInfo($conn, $seatName);
            $status .= "<p>樓層：$seatFloor<br></p>";
            $status .= "插座：$socketInfo<br>";
        }

        return $status;
    } else {
        // Seat is not reserved
        return "<p>此座位尚未被預約</p>";
    }
}

// Function to get all seat options
// Function to get all seat options
function getSeatOptions($conn)
{
    $options = "";
    $query = "SELECT Seat_Name FROM seat ORDER BY Seat_Name"; // Add ORDER BY clause
    $result = $conn->query($query);

    if ($result->num_rows > 0) {
        while ($row = $result->fetch_assoc()) {
            $seatName = $row['Seat_Name'];
            $options .= "<option value='$seatName'>$seatName</option>";
        }
    }

    return $options;
}


// Function to get seat floor based on seat name
function getSeatFloor($conn, $seatName)
{
    $query = "SELECT Seat_Floor FROM seat WHERE Seat_Name = '$seatName'";
    $result = $conn->query($query);

    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        return $row['Seat_Floor'];
    }

    return "";
}

// Function to get socket info based on seat name
function getSocketInfo($conn, $seatName)
{
    $query = "SELECT Socket FROM seat WHERE Seat_Name = '$seatName'";
    $result = $conn->query($query);

    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        return $row['Socket'];
    }

    return "";
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座位查詢</title>
    <style>
        /* Navbar 樣式 */
        .navbar {
            overflow: hidden;
            background-color: #333;
        }

        .navbar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
        }

        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <div class='navbar'>
        <a href='../userstatus.php'>會員</a>
        <a href='../seat/seat.php'>座位</a>
        <a href='../reservation/reservation.php'>預約紀錄</a>
        <a href='../reservation/newreservation.php'>新增預約</a>
        <a href='../logout.php' style='float:right;'>登出</a>
    </div>

    <div class="container" style="width: 700px; margin: 0px auto; top:50px; margin-bottom 200px; font-family: Microsoft JhengHei;">
        <h2>座位查詢</h2>

<form action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post" enctype="multipart/form-data">
    <label for="seatname">選擇座位編號：</label>
    <select id="seatname" name="seatname">
        <?php
        // Output seat options
        echo $seatOptions;

        // Loop through seat options and mark the selected seat as 'selected'
        // Note: Comment out this loop for now, as it's not needed here
        /*while ($row = $result->fetch_assoc()) {
            $seatName = $row['Seat_Name'];
            $selected = ($selectedSeat == $seatName) ? "selected" : "";
            echo "<option value='$seatName' $selected>$seatName</option>";
        }*/
        ?>
    </select>
    <button type="submit">確認</button>
    <?php echo $reservationStatus; ?>
</form>



    </div>
</body>

</html>
